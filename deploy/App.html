<!DOCTYPE html>
<html>
<head>
    <title>PI_Grid</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext,app=null;Ext.define("CustomApp",{extend:"Rally.app.App",uses:["Ext.ux.exporter.Exporter"],componentCls:"app",launch:function(){this._GridRecords=[],this._boxcontainer=Ext.create("Ext.form.Panel",{layout:{type:"hbox"},width:"95%",bodyPadding:10}),this._loadReleases()},_loadReleases:function(){app=this,this._releaseCombobox=this.add({xtype:"rallyreleasecombobox",listeners:{ready:this._loadFeatures,change:this._onReleaseComboboxChanged,scope:this}}),this._myButton=this.add({xtype:"rallybutton",height:20,text:"Export to CSV",listeners:{scope:this,click:function(){var exporter=Ext.create("GridExporter",{});exporter.exportGrid(app._myGrid)}}}),this._boxcontainer.add(this._releaseCombobox),this._boxcontainer.add(this._myButton),this.add(this._boxcontainer)},_loadFeatures:function(){this._myStore=Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Feature",autoLoad:!0,filters:this._getFilter(),context:this.getContext().getDataContext(),remoteSort:!1,listeners:{load:function(store,records,success){this._getGrandparents(records)},scope:this},fetch:["Name","FormattedID","CustomField1","Release","Parent"]})},_getGrandparents:function(data){var me=this,gridRecord=[],lastRecord=!1,length=data.length;Ext.Array.each(data,function(record){length--,0===length&&(lastRecord=!0),gridRecord={_ref:record.get("_ref"),ObjectID:record.get("ObjectID"),FormattedID:record.get("FormattedID"),Release:record.get("Release"),Name:record.get("Name"),Parent:record.get("Parent"),Grandparent:0},me._setGrandparent(gridRecord,lastRecord),me._GridRecords.push(gridRecord)})},_setGrandparent:function(gridRecord,lastRecord){var parent=gridRecord.Parent;parent&&Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Initiative",autoLoad:!0,filters:[{property:"Name",operator:"=",value:parent.Name}],fetch:["Name","Parent","FormattedID","_ref"],listeners:{load:function(store,data,success){this._onInitiativesLoaded(data,gridRecord,lastRecord)},scope:this}})},_onInitiativesLoaded:function(resultsData,currentRec,lastRecord){var me=this,gp;Ext.Array.each(resultsData,function(record){gp=record.get("Parent")}),gp&&(currentRec.Grandparent=gp),lastRecord&&me._createGrid(resultsData),console.log("grid data: ",currentRec)},_getFilter:function(){var combo=this.down("rallyreleasecombobox"),execFilter=Ext.create("Rally.data.wsapi.Filter",{property:"CustomField1",operator:"=",value:"Exec"}),releaseFilter=combo.getQueryFromSelected(),filter=releaseFilter.and(execFilter);return filter},_onReleaseComboboxChanged:function(){if(this._myGrid){var store=this._myGrid.getStore();store.clearFilter(!0),this._myGrid.destroy(),this._GridRecords=[],this._loadFeatures()}else console.log("grid not created yet")},renderName:function(value,meta,rec,row,col){return value?value.Name:value},renderID:function(value,meta,rec,row,col){return value?value.FormattedID:value},renderParent:function(value,meta,rec,row,col){return value.name},_createGrid:function(gridRecords){this._myGrid=this.add({xtype:"rallygrid",columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},{text:"Release",dataIndex:"Release",renderer:this.renderName,flex:1},{xtype:"templatecolumn",text:"Parent ID",dataIndex:"Parent",renderer:this.renderID,tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Parent",dataIndex:"Parent",renderer:this.renderName},{xtype:"templatecolumn",text:"Grandparent ID",dataIndex:"Grandparent",renderer:this.renderID,tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Grandparent",dataIndex:"Grandparent",renderer:this.renderName,flex:2}],context:this.getContext(),store:Ext.create("Rally.data.custom.Store",{data:this._GridRecords,model:"PortfolioItem/Feature",height:"98%"})})}});
                Ext.define("GridExporter",{dateFormat:"Y-m-d g:i",exportGrid:function(grid){if(Ext.isIE)this._ieToExcel(grid);else{var data=this._getCSV(grid);window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)}},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData){var text;return text=null===fieldData||void 0===fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData.match?fieldData:""},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="",that=this;return Ext.Array.each(cols,function(col,index){col.hidden!==!0&&(data+=that._getFieldTextAndEscape(col.text)+",")}),data+="\n",store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName];data+=that._getFieldTextAndEscape(text)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){col.hidden!==!0&&(console.log("header: ",col.text),sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}xlBook.worksheets("Sheet1").activate();var XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet),XlSheet.columns.autofit()}}});

            Rally.launchApp('CustomApp', {
                name:"PI_Grid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
